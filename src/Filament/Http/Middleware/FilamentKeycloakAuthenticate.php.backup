<?php

namespace Ebrook\KeycloakWebGuard\Filament\Http\Middleware;

use Filament\Facades\Filament;
use Illuminate\Auth\Middleware\Authenticate;
use Illuminate\Http\Request;

class FilamentKeycloakAuthenticate extends Authenticate
{
    protected function redirectTo(Request $request): ?string
    {
        if ($request->expectsJson()) {
            return null;
        }

        // Get the panel to determine the correct login route
        $panel = Filament::getCurrentPanel();
        if (!$panel) {
            $path = $request->path();
            if (str_starts_with($path, 'app/')) {
                $panel = Filament::getPanel('app');
            }
        }
        
        if ($panel) {
            // Return the panel's login URL
            return $panel->getLoginUrl();
        }

        return route('keycloak.login');
    }

    protected function authenticate($request, array $guards): void
    {
        // Get the panel from the request
        $panel = Filament::getCurrentPanel();
        
        if (!$panel) {
            // Try to identify panel from route path
            $path = $request->path();
            if (str_starts_with($path, 'app/')) {
                $panel = Filament::getPanel('app');
            }
        }
        
        if ($panel) {
            // Set current panel context (important for Filament to work correctly)
            Filament::setCurrentPanel($panel);
            
            // Get the auth guard name for this panel
            $guardName = $panel->getAuthGuard();
            
            // Use Auth facade with the specific guard name
            $guard = \Illuminate\Support\Facades\Auth::guard($guardName);
            

            // Log for debugging
            \Illuminate\Support\Facades\Log::debug('FilamentKeycloakAuthenticate: Checking authentication', [
                'panel_id' => $panel->getId(),
                'guard_name' => $guardName,
                'guard_class' => get_class($guard),
                'is_authenticated' => $guard->check(),
                'user' => $guard->user() ? get_class($guard->user()) : null,
                'request_path' => $request->path(),
                'session_id' => session()->getId(),
                'token_in_session' => !is_null(\Ebrook\KeycloakWebGuard\Facades\KeycloakWeb::retrieveToken()),
            ]);
            
            // Check if user is authenticated with this guard
            if ($guard->check()) {
                $user = $guard->user();
                \Illuminate\Support\Facades\Log::debug('FilamentKeycloakAuthenticate: User authenticated successfully', [
                    'user_class' => get_class($user),
                    'user_email' => $user->email ?? null,
                ]);

                // Set tenant context and potentially switch user account for tenant switching
                $targetTenant = null;
                $targetUser = $user; // Default to current user

                // Check if URL contains tenant parameter (for tenant switching)
                $routeParams = $request->route() ? $request->route()->parameters() : [];
                if (isset($routeParams['tenant'])) {
                    $urlTenantId = $routeParams['tenant'];

                    // Validate tenant_id: must be positive integer
                    if (!is_numeric($urlTenantId) || $urlTenantId <= 0 || $urlTenantId > 999999) {
                        \Illuminate\Support\Facades\Log::warning('FilamentKeycloakAuthenticate: Invalid tenant ID format', [
                            'tenant_id' => $urlTenantId,
                            'type' => gettype($urlTenantId),
                        ]);
                        // Continue with default tenant logic
                    } else {
                        // Find tenant by ID from URL
                        $urlTenant = \App\Models\Tenant::find((int)$urlTenantId);
                    if ($urlTenant) {
                        // Validate user email format and length
                        $userEmail = $user->email ?? '';
                        if (!filter_var($userEmail, FILTER_VALIDATE_EMAIL) || strlen($userEmail) > 254) {
                            \Illuminate\Support\Facades\Log::warning('FilamentKeycloakAuthenticate: Invalid user email format', [
                                'email_length' => strlen($userEmail),
                            ]);
                            // Continue with default tenant logic
                        } else {
                            // Check if user has access to this tenant (find the user account for this tenant)
                            $tenantUser = \App\Models\Tenant\User::where('email', $userEmail)
                                ->where('tenant_id', (int)$urlTenantId)
                                ->first();

                        if ($tenantUser) {
                            $targetTenant = $urlTenant;
                            $targetUser = $tenantUser; // Switch to the user account for this tenant
                            // Only log detailed info in non-production environments
                            if (!\Illuminate\Support\Facades\App::environment('production')) {
                                \Illuminate\Support\Facades\Log::debug('FilamentKeycloakAuthenticate: Switching to user account for tenant', [
                                    'url_tenant_id' => $urlTenantId,
                                    'original_user_id' => $user->id,
                                    'target_user_id' => $targetUser->id,
                                    'user_email_hash' => hash('sha256', $user->email), // Hash sensitive data
                                ]);
                            }
                        } else {
                            \Illuminate\Support\Facades\Log::warning('FilamentKeycloakAuthenticate: User does not have account in requested tenant', [
                                'url_tenant_id' => $urlTenantId,
                                'user_email_hash' => hash('sha256', $user->email), // Hash sensitive data
                            ]);
                        }
                    }
                }

                // Fall back to user's default tenant if no URL tenant or no access
                if (!$targetTenant && method_exists($user, 'tenant') && $user->tenant) {
                    $targetTenant = $user->tenant;
                }

                if ($targetTenant) {
                    // If we're switching user accounts, update the authenticated user
                    if ($targetUser->id !== $user->id) {
                        // Store original user for rollback
                        $originalUser = $user;

                        try {
                            // Log the user switch (remove sensitive info in production)
                            if (!\Illuminate\Support\Facades\App::environment('production')) {
                                \Illuminate\Support\Facades\Log::debug('FilamentKeycloakAuthenticate: Switching authenticated user for tenant', [
                                    'from_user_id' => $user->id,
                                    'to_user_id' => $targetUser->id,
                                    'tenant_id' => $targetTenant->id,
                                ]);
                            }

                            // Update the authenticated user in the guard (atomic operation)
                            $guard->setUser($targetUser);
                            $this->auth->setUser($targetUser);

                        } catch (\Exception $e) {
                            // Rollback: restore original user if switching failed
                            try {
                                $guard->setUser($originalUser);
                                $this->auth->setUser($originalUser);
                            } catch (\Exception $rollbackException) {
                                // Log critical error if rollback also fails
                                \Illuminate\Support\Facades\Log::critical('FilamentKeycloakAuthenticate: Failed to rollback user switch', [
                                    'error' => $rollbackException->getMessage(),
                                    'original_user_id' => $originalUser->id,
                                ]);
                            }

                            // Log the original error
                            \Illuminate\Support\Facades\Log::error('FilamentKeycloakAuthenticate: Failed to switch authenticated user', [
                                'error' => $e->getMessage(),
                                'from_user_id' => $user->id,
                                'to_user_id' => $targetUser->id,
                                'tenant_id' => $targetTenant->id,
                            ]);

                            // Continue with original user and default tenant
                            $targetUser = $originalUser;
                            $targetTenant = method_exists($originalUser, 'tenant') && $originalUser->tenant
                                ? $originalUser->tenant
                                : null;
                        }
                    }


                    \Filament\Facades\Filament::setTenant($targetTenant);
                    // Only log detailed info in non-production environments
                    if (!\Illuminate\Support\Facades\App::environment('production')) {
                        \Illuminate\Support\Facades\Log::debug('FilamentKeycloakAuthenticate: Tenant context set', [
                            'tenant_id' => $targetTenant->id,
                            'tenant_name' => $targetTenant->name,
                            'source' => isset($routeParams['tenant']) ? 'url_parameter' : 'user_default',
                            'user_switched' => $targetUser->id !== $user->id,
                        ]);
                    }
                }

                $this->auth->shouldUse($guardName);
                return;
            }
            
            // If not authenticated, try to authenticate from session token
            // This handles the case where token is in session but guard hasn't loaded it yet
            $token = \Ebrook\KeycloakWebGuard\Facades\KeycloakWeb::retrieveToken();
            if ($token && !empty($token['access_token'])) {
                \Illuminate\Support\Facades\Log::debug('FilamentKeycloakAuthenticate: Attempting to authenticate from session token');
                if ($guard->validate($token)) {
                    $this->auth->shouldUse($guardName);
                    return;
                }
            }
            
            // Log why authentication failed
            \Illuminate\Support\Facades\Log::warning('FilamentKeycloakAuthenticate: Authentication failed', [
                'guard_name' => $guardName,
                'guard_check' => $guard->check(),
                'token_exists' => !is_null($token),
                'request_path' => $request->path(),
            ]);
        }

        // Fallback: try default Filament auth
        $guard = Filament::auth();
        if ($guard && $guard->check()) {
            $this->auth->shouldUse(Filament::getAuthGuard());
            return;
        }

        $this->unauthenticated($request, $guards);
        }
    }
}
